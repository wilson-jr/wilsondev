<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forsaken World Interactive Map</title>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" rel="stylesheet" />

  <!-- Bootstrap CSS & JS Bundle -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <button type="button" class="btn btn-primary position-fixed m-3" style="bottom: 0; right: 0; z-index: 1000;" id="toggleControls">
    Границы
  </button>

  <div id="coordsPanel" class="card p-2 shadow-sm position-fixed" style="bottom: 60px; right: 10px; width: 320px; z-index: 1000; display: none;">
    <div class="mb-2">
      <textarea id="coordinatesOutput" class="form-control" rows="6" style="font-family: monospace; font-size: 12px;"></textarea>
    </div>
    <div class="d-flex flex-wrap gap-1">
      <button class="btn btn-sm btn-success" id="startPolygon">Начать</button>
      <button class="btn btn-sm btn-secondary" id="finishPolygon">Завершить</button>
      <button class="btn btn-sm btn-warning" id="undoPoint">Удалить точку</button>
      <button class="btn btn-sm btn-danger" id="clearCoords">Очистить</button>
      <button class="btn btn-sm btn-outline-primary" id="copyCoords">Скопировать</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="mapdata.js"></script>

  <!-- ОПРЕДЕЛЕНИЕ КАРТЫ, ПОЛИГОНОВ И МАРКЕРОВ -->
  <script>
    // Карта
    var map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      minZoom: 2,
      maxZoom: 6
    });

    var imageWidth = 5760;
    var imageHeight = 2868;
    var aspectRatio = imageWidth / imageHeight;

    var southWest = L.latLng(-90, -180 * aspectRatio);
    var northEast = L.latLng(90, 180 * aspectRatio);
    var bounds = L.latLngBounds(southWest, northEast);

    L.imageOverlay('forsakenworldmap.png', bounds).addTo(map);
    map.setMaxBounds(bounds);
    map.on('drag', function () {
      map.panInsideBounds(bounds, { animate: false });
    });
    map.setView([0, 0], 2);

    // Создаем слои по группам
    const layerGroups = {};

    function getOrCreateLayerGroup(groupName) {
      if (!layerGroups[groupName]) {
        layerGroups[groupName] = L.layerGroup();
      }
      return layerGroups[groupName];
    }

    // Отрисовка полигонов
    polygons.forEach(polygon => {
      const layer = L.polygon(polygon.coordinates, {
        color: polygon.color,
        dashArray: polygon.dashArray
      }).bindPopup(`<b>${polygon.name}</b><br>${polygon.description}`);

      const group = getOrCreateLayerGroup(polygon.group || "Прочее");
      layer.addTo(group);
    });

    // Отрисовка маркеров
    markers.forEach(marker => {
      const layer = L.marker(marker.coordinates, {
        icon: L.icon({ iconUrl: marker.iconUrl, iconSize: [28, 28] })
      }).bindPopup(`<b>${marker.name}</b><br>${marker.description}`);

      const group = getOrCreateLayerGroup(marker.group || "Прочее");
      layer.addTo(group);
    });

    // Добавление всех групп на карту и подготовка слоёв
    const overlayMaps = {};
    Object.keys(layerGroups).forEach(groupName => {
      const groupLayer = layerGroups[groupName];
      groupLayer.addTo(map); // Можно убрать, если хочешь их по умолчанию выключенными
      overlayMaps[groupName] = groupLayer;
    });

    // Добавляем контрол переключения слоёв
    L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

  </script>

  <!-- КОПИРОВАНИЕ КООРДИНАТ ПО КЛИКУ НА КАРТЕ -->
  <script>
      function onMapClick(e) {
        var lat = e.latlng.lat.toFixed(6);
        var lng = e.latlng.lng.toFixed(6);
        var coordsText = lat + ", " + lng;

        // Копирование координат в буфер обмена
        navigator.clipboard.writeText("[" + coordsText + "]").then(function () {
          console.log("Скопировано в буфер: " + coordsText);
        }).catch(function (err) {
          console.error("Ошибка при копировании: ", err);
        });
      }

      map.on('click', onMapClick);
  </script>

  <!-- СОЗДАНИЕ ГРАНИЦ -->
  <script>
    let collecting = false;
    let collectedCoords = [];
    let tempPolygon = null;
    const coordsOutput = document.getElementById('coordinatesOutput');

    function updateOutput() {
      coordsOutput.value = '[' + collectedCoords.map(c => '[' + c[0] + ', ' + c[1] + ']').join(',') + ' ]';
    }

    function redrawPolygon() {
      if (tempPolygon) {
        map.removeLayer(tempPolygon);
      }
      if (collectedCoords.length > 1) {
        tempPolygon = L.polygon(collectedCoords, { color: 'blue', dashArray: '4' }).addTo(map);
      }
    }

    document.getElementById('toggleControls').addEventListener('click', () => {
      const panel = document.getElementById('coordsPanel');
      panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    });

    document.getElementById('startPolygon').addEventListener('click', () => {
      collecting = true;
      collectedCoords = [];
      updateOutput();
      redrawPolygon();
    });

    document.getElementById('finishPolygon').addEventListener('click', () => {
      collecting = false;
      redrawPolygon();
    });

    document.getElementById('undoPoint').addEventListener('click', () => {
      collectedCoords.pop();
      updateOutput();
      redrawPolygon();
    });

    document.getElementById('clearCoords').addEventListener('click', () => {
      collectedCoords = [];
      updateOutput();
      if (tempPolygon) {
        map.removeLayer(tempPolygon);
        tempPolygon = null;
      }
    });

    document.getElementById('copyCoords').addEventListener('click', () => {
      navigator.clipboard.writeText(coordsOutput.value).then(() => {
        alert('Координаты скопированы!');
      });
    });

    map.on('click', function (e) {
      if (!collecting) return;

      const lat = +e.latlng.lat.toFixed(6);
      const lng = +e.latlng.lng.toFixed(6);
      collectedCoords.push([lat, lng]);

      updateOutput();
      redrawPolygon();
    });
  </script>
</body>
</html>
